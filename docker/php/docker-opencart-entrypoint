#!/bin/bash
set -e

# Create a symbolic link to make the upload directory the document root.
# The -n flag is crucial to replace the symlink correctly if it exists.
ln -sfn /var/www/upload /var/www/public_html

echo "--- OpenCart initialization ---"

# Change to the correct working directory after the symlink is created
cd /var/www/public_html

# Check if OpenCart needs installation
if [ ! -f /var/www/public_html/install.lock ] && [ -f /var/www/public_html/install/cli_install.php ]; then
    echo "--- Starting OpenCart installation ---"

    # Copy config files if they don't exist
    if [ -f /var/www/public_html/config-dist.php ] && [ ! -s /var/www/public_html/config.php ]; then
        cp /var/www/public_html/config-dist.php /var/www/public_html/config.php
        echo "--- Copied config-dist.php to config.php ---"
    fi

    if [ -f /var/www/public_html/admin/config-dist.php ] && [ ! -s /var/www/public_html/admin/config.php ]; then
        cp /var/www/public_html/admin/config-dist.php /var/www/public_html/admin/config.php
        echo "--- Copied admin/config-dist.php to admin/config.php ---"
    fi

    # Run installer
    php /var/www/public_html/install/cli_install.php install \
        --username admin \
        --password admin \
        --email email@example.com \
        --http_server http://localhost/ \
        --db_driver mysqli \
        --db_hostname mysql \
        --db_username root \
        --db_password opencart \
        --db_database opencart \
        --db_port 3306 \
        --db_prefix oc_ \
        && touch /var/www/public_html/install.lock \
        && echo "--- OpenCart installation completed ---" \
        || echo "--- OpenCart installation failed ---"
fi

# Copy .htaccess.txt to .htaccess if needed
if [ -f /var/www/public_html/.htaccess.txt ] && [ ! -f /var/www/public_html/.htaccess ]; then
    cp /var/www/public_html/.htaccess.txt /var/www/public_html/.htaccess
    echo "--- Copied .htaccess.txt to .htaccess ---"
fi

# Fix ownership for all files by targeting the real directory.
echo "--- Fixing ownership on /var/www/upload ---"
chown -R www-data:www-data /var/www/upload
echo "--- Ownership fixed ---"

# Set permissions for storage relocation
echo "--- Setting permissions for storage relocation ---"
chown www-data:www-data /var/www
chmod 755 /var/www

# Call the original entrypoint with all arguments
exec docker-php-entrypoint "$@"
