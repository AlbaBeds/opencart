#!/bin/bash
set -e

echo "--- OpenCart initialization ---"

# Check if OpenCart needs installation
if [ ! -f /var/www/public_html/upload/install.lock ] && [ -f /var/www/public_html/upload/install/cli_install.php ]; then
    echo "--- Starting OpenCart installation ---"

    # Copy config files if they don't exist
    if [ -f /var/www/public_html/upload/config-dist.php ] && [ ! -s /var/www/public_html/upload/config.php ]; then
        cp /var/www/public_html/upload/config-dist.php /var/www/public_html/upload/config.php
        echo "--- Copied config-dist.php to config.php ---"
    fi

    if [ -f /var/www/public_html/upload/admin/config-dist.php ] && [ ! -s /var/www/public_html/upload/admin/config.php ]; then
        cp /var/www/public_html/upload/admin/config-dist.php /var/www/public_html/upload/admin/config.php
        echo "--- Copied admin/config-dist.php to admin/config.php ---"
    fi

    # Run installer
    php /var/www/public_html/upload/install/cli_install.php install \
        --username admin \
        --password admin \
        --email email@example.com \
        --http_server http://localhost/ \
        --db_driver mysqli \
        --db_hostname mysql \
        --db_username root \
        --db_password opencart \
        --db_database opencart \
        --db_port 3306 \
        --db_prefix oc_ \
        && touch /var/www/public_html/upload/install.lock \
        && echo "--- OpenCart installation completed ---" \
        || echo "--- OpenCart installation failed ---"
fi

# Copy .htaccess.txt to .htaccess if needed
if [ -f /var/www/public_html/upload/.htaccess.txt ] && [ ! -f /var/www/public_html/upload/.htaccess ]; then
    cp /var/www/public_html/upload/.htaccess.txt /var/www/public_html/upload/.htaccess
    echo "--- Copied .htaccess.txt to .htaccess ---"
fi

# Fix permissions for OpenCart files (exclude .git)
echo "--- Fixing file permissions ---"
find /var/www/public_html -name '.git' -prune -o -type f -exec chown www-data:www-data {} + 2>/dev/null || true
find /var/www/public_html -name '.git' -prune -o -type d -exec chown www-data:www-data {} + 2>/dev/null || true

# Set permissions for storage relocation
echo "--- Setting permissions for storage relocation ---"
chown www-data:www-data /var/www
chmod 755 /var/www

# Fix specific permissions for OpenCart (exclude .git)
find /var/www/public_html -name '.git' -prune -o -type d -exec chmod 755 {} + 2>/dev/null || true
find /var/www/public_html -name '.git' -prune -o -type f -exec chmod 644 {} + 2>/dev/null || true

# Call the original entrypoint with all arguments
exec docker-php-entrypoint "$@"
